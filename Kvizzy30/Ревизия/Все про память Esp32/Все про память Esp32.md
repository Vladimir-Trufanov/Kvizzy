## [Все про память Esp32](#)

ESP32 представляет собой двухъядерную систему с двумя процессорами Xtensa LX6 гарвардской архитектуры. Вся встроенная память, внешняя память и периферийные устройства расположены на шине данных и шине команд этих процессоров.

За некоторыми незначительными исключениями, отображение адресов двух процессоров симметрично, что означает, что они используют одни и те же адреса для доступа к одной и той же памяти. 

Некоторые периферийные устройства также напрямую (через DMA-Direct Memory Access) могут обращаться к встроенной памяти.

### *[Адресное пространство:](#)*

- cимметричное отображение адресов;
- доступ к некоторым областям встроенной и внешней памяти возможен как по шине данных так и по шине команд;
- 4 ГБ (32-разрядного) адресного пространства как для шины данных, так и для шины команд;
- 1296 КБ адресного пространства встроенной памяти;
- 19704 КБ адресного пространства внешней памяти;
- 512 КБ адресного пространства периферийных устройств;
- 328 КБ адресного пространства DMA

### *[Встрoенная память:](#%D0%B2%D1%81%D1%82%D1%80%D0%BE%D0%B5%D0%BD%D0%BD%D0%B0%D1%8F-%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D1%8C)*

- 448 КБ встроенного ПЗУ (ROM - энергонезависимой постоянной памяти);
- 520 КБ встроенной оперативной памяти для данных и инструкций (SRAM);
- 8 КБ быстрой оперативной памяти RTC (Real-Time Clock FAST Memory);
- 8 КБ медленной оперативной памяти RTC (Real-Time Clock SLOW Memory)

### *[Внешняя память (Flash)](#%D0%B2%D0%BD%D0%B5%D1%88%D0%BD%D1%8F%D1%8F-%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D1%8C)*

разбивается на разделы и может использоваться с различными назначениями:

- поддерживается до 16 МБ файловой системы для хранения больших данных в виде файлов (например SPIFFS - SPI Flash File Storage);
- поддерживается до 8 МБ SPI SRAM, как оперативной памяти для данных и инструкций.

Внешняя память может быть использовано контроллером, как доступное адресное пространство, вместо встроенной памяти. В этом случае часть встроенной памяти становится кэшем для внешней памяти.

### *[DМA](#dma)*

- 13 модулей способны работать в режиме DMA

### *[Перифeрийные устройства](#%D0%BF%D0%B5%D1%80%D0%B8%D1%84%D0%B5%D1%80%D0%B8%D0%B9%D0%BD%D1%8B%D0%B5-%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%B0)*

- 41 периферийное устройство

![](Win10ChDe352k.png)

### *Встроенная память*

Внутреннее ПЗУ разделено на две части: Internal ROM0 (384 КБ) и Internal ROM1 (64 КБ).

Внутренняя оперативная память разделена на три части: Internal SRAM0  (192 КБ), Internal SRAM1 (128 КБ) и Internal SRAM2 (200 Кбайт).

RTC FAST Memory (8 КБ) может использоваться для хранения данных, к ней обращается основной процессор во время загрузки RTC из режима глубокого сна. 

RTC SLOW Memory (8 КБ) доступна только сопроцессору ULP в режиме глубокого сна. Сопроцессор ULP (ultra-low-power processor - процессор со сверхнизким потреблением) остаётся в работе в режиме пониженного энергопотреблении Deep Sleep. В данном режиме основные два ядра контроллера не работают. 

#### *Внутреннее ПЗУ0 - Internal ROM0*

Объем внутреннего ПЗУ0 составляет 384 КБ. Доступ к нему осуществляется обоими процессорами через диапазон адресов 0x4000_0000 - 0x4005_FFFF, который находится на шине команд.

Диапазон адресов первых 32 КБ ПЗУ0 (0x4000_0000 - 0x4000_7FFF) может быть переназначен для доступа к части внутренней памяти SRAM1, которая обычно находится в диапазоне памяти 0x400B_0000 - 0x400B_7FFF.

При переназначении 32-килобайтная SRAM-память больше не может быть доступна с диапазоном адресов 0x400B_0000 - 0x400B_7FFF, но она все еще может быть доступна через шину данных 0x3FFE_8000 - 0x3FFE_FFFF.

Это можно сделать для каждого процессора: установка бита 0 в регистре DPORT_PRO_BOOT_REMAP_CTRL_REG или DPORT_APP_BOOT_REMAP_CTRL_REG приведет к переназначению SRAM для PRO_CPU и APP_CPU соответственно.

#### *Внутреннее ПЗУ1 - Internal ROM1* 

Емкость внутреннего ПЗУ1 составляет 64 КБ. Оно может быть прочитано любым процессором в диапазоне адресов 0x3FF9_0000 - 0x3FF9_FFFF шины данных.

#### *Внутренняя оперативная память SRAM0*

Емкость внутренней памяти SRAM0 составляет 192 КБ. Аппаратное обеспечение может быть настроено таким образом, чтобы использовать первые 64 КБ для кэширования доступа к внешней памяти. Когда они не используются в качестве кэша, первые 64 КБАЙТ могут быть считаны и записаны любым процессором по адресам 0x4007_0000 - 0x4007_FFFF шины команд. 

Оставшиеся 128 КБАЙТ всегда могут быть считаны и записаны
любым процессором по адресам 0x4008_0000 - 0x4009_FFFF шины команд.

#### *Внутренняя память SRAM1*

Емкость внутренней памяти SRAM1 составляет 128 КБАЙТ. Любой центральный процессор может считывать и записывать данные из этой памяти по адресам 0x3FFE_0000 - 0x3FFF_FFFF шины данных, а также по адресам 0x400A_0000 - 0x400B_FFFF шины команд.

Доступ к диапазону адресов по шине команд осуществляется в обратном порядке (по словам) по сравнению с доступом по шине данных. 

То есть, адреса:
```
0x3FFE_0000 и 0x400B_FFFC обращаются к одному и тому же слову
0x3FFE_0004 и 0x400B_FFF8 используют одно и то же слово
0x3FFE_0008 и 0x400B_FFF4 используют одно и то же слово
……
0x3FFF_FFF4 и 0x400A_0008 обращаются к одному и тому же слову
0x3FFF_FFF8 и 0x400A_0004 используют одно и то же слово
0x3FFF_FFFC и 0x400A_0000 используют одно и то же слово
```
Как шина данных, так и шина команд центрального процессора по-прежнему имеют начальный порядок байтов, поэтому порядок байтов отдельных слов
в адресных пространствах не меняется на противоположный. 

Например, адреса:

```
0x3FFE_0000 обращается к младшему значащему байту в слове, к которому обращается 0x400B_FFFC;
0x3FFE_0001 обращается ко второму по старшинству байту в слове, к которому обращается 0x400B_FFFC;
0x3FFE_0002 обращается ко второму по старшинству байту в слове, к которому обращается 0x400B_FFFC;
0x3FFE_0003 обращается к старшему значащему байту в слове, к которому обращается 0x400B_FFFC.

0x3FFE_0004 обращается к младшему значащему байту в слове, к которому обращается 0x400B_FFF8;
0x3FFE_0005 обращается ко второму по старшинству байту в слове, к которому обращается 0x400B_FFF8;
0x3FFE_0006 обращается ко второму по старшинству байту в слове, к которому обращается 0x400B_FFF8;
0x3FFE_0007 обращается к старшему значащему байту в слове, к которому обращается 0x400B_FFF8.
```
Часть этой памяти может быть переназначена в адресное пространство ROM0. 

#### *Внутренняя память SRAM2*

Емкость внутренней памяти SRAM2 составляет 200 КБАЙТ. Она может считываться и записываться любым процессором по адресам 0x3FFA_E000 - 0x3FFD_FFFF на шине данных.


#### *RTC FAST Memory*

RTC FAST Memory составляет 8 КБ оперативной памяти SRAM. Он может быть прочитан и записан ***PRO_CPU*** только в диапазоне адресов 0x3FF8_0000-0x3FF8_1FFF на шине данных или в диапазоне адресов 0x400C_0000 - 0x400C_1FFF на шине команд. В отличие от большинства других областей памяти, быстрая память RTC недоступна для ***APP_CPU***.

Два диапазона адресов PRO_CPU обращаются к быстрой памяти RTC в одинаковом порядке, например, адреса 0x3FF8_0000 и 0x400C_0000 используют одно и то же слово. В APP_CPU эти диапазоны адресов не
предоставляют доступ к оперативной памяти RTC или к любой другой ячейке памяти.

#### *RTC SLOW Memory*

RTC SLOW Memory  - это 8 КБ SRAM, которые могут считываться и записываться любым процессором с диапазоном адресов
0x5000_0000 - 0x5000_1FFF. Этот диапазон адресов совместно используется как шиной данных, так и шиной команд. 

###### [в начало](#%D0%B2%D1%81%D0%B5-%D0%BF%D1%80%D0%BE-%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D1%8C-esp32)

### *Внешняя память*

ESP32 может использовать SPI flash и SPI SRAM в качестве внешней памяти. Когда центральный процессор обращается к внешней памяти через кэш, то адрес в кэше сопоставляется  с адресом внешней физической памяти в соответствии с настройками MMU (устройство управления памятью, которое выполняет трансляцию адресов памяти между физическими и виртуальными адресами, благодаря этому процессор может обращаться к физической памяти через виртуальные адреса).

Благодаря такому сопоставлению адресов ESP32 может адресовать до 16 МБ внешней флэш-памяти и 8 МБ внешней SRAM.

#### Cache

Каждый из двух процессоров в ESP32 имеет 32 КБ кэш-памяти с размером блока в 32 байта для доступа к внешнему хранилищу. PRO CPU использует бит PRO_CACHE_ENABLE в регистре DPORT_PRO_CACHE_CTRL_REG
для включения кэширования, в то время как APP CPU использует бит APP_CACHE_ENABLE в регистре DPORT_APP_CACHE_CTRL_REG
для включения той же функции.

![Структурная схема кэша](Cache-Block-Diagram.jpg)

ESP32 использует несколько вариантов подключения к кэшу процессора PRO CPU и APP CPU. 

Биты CACHE_MUX_MODE в регистре DPORT_CACHE_MUX_MODE_REG ставят в соответствие пулы кэша: POOL0 или POOL1 во внутреннем SRAM0 нулевому или первому процессору для  использования в качестве кэш-памяти. 

Когда и PRO CPU, и APP CPU используют функцию кэширования,
POOL0 и POOL1 во внутренней памяти SRAM0 будут использоваться одновременно в качестве кэш-памяти, в то время как они также могут
использоваться и шиной команд. 

![Режимы использования кэш памяти](Cache-memory-mode.jpg)

Как видно, когда бит CACHE_MUX_MODE равен 1 или 2, PRO CPU и APP CPU не могут одновременно включить функцию кэширования. 

Когда функция кэширования включена, POOL0 или POOL1 могут использоваться в качестве кэш-памяти для External Memory и поэтому соответствующее пространство адресов не может использоваться шиной команд.

Кэш ESP32 поддерживает функцию очистки. Но стоит отметить, что при использовании функции Flush данные, записанные в кэш, будут удалены, а не перезаписаны во внешнюю SRAM. 

Для того, чтобы включить функцию Flush, следует сначала очистить бит x_CACHE_FLUSH_ENA в регистре DPORT_x_CACHE_CTRL_REG, а затем установить этот бит равным 1. После этого системное оборудование установит бит x_CACHE_FLUSH_DONE равным 1, где x может быть ”PRO” или ”APP”,
указывая на то, что операция очистки кэша завершена.

###### [в начало](#%D0%B2%D1%81%D0%B5-%D0%BF%D1%80%D0%BE-%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D1%8C-esp32)

### *DMA*

DMA в ESP32 - это контроллер прямого доступа к памяти (***Direct Memory Access***). Он позволяет некоторым периферийным устройствам (UART, SPI, I2C, Ethernet и другим) работать с ОЗУ напрямую, то есть без участия процессора. Это помогает разгрузить процессор и ускорить процесс обмена данными между памятью и периферией, поэтому в ряде случаев грамотное использование DMA позволяет существенно увеличить скорость работы программы. 

DMA использует ту же адресацию, что и шина данных центрального процессора:  для чтения и записи во внутреннюю SRAM1 0x3FFE_0000 - 0x3FFF_FFFF, для чтения и записи во внутреннюю SRAM2 0x3FFA_E000 - 0x3FFD_FFFF.

В микроконтроллерах ESP32 прямой доступ к памяти имеют 13 периферийных устройств:

![Устройства с прямым доступом к памяти](module-with-dma.jpg)

***[UARTx](#)*** - инструменты последовательной связи для обмена данными между двумя устройствами по протоколу UART (Universal Asynchronous Receiver-Transmitter).

В отличие от SPI или I2C, которые являются синхронными, UART является асинхронным, то есть он не использует тактовый сигнал для синхронизации передачи данных между устройствами. Однако оба устройства должны согласовывать скорость передачи данных (baud).

В UART-коммуникации данные передаются последовательно, побитно, с заранее определённой скоростью (битами в секунду). Для передачи данных используется одна линия (TX), а для приёма — другая (RX).

UART-порты позволяют обмениваться данными с другими устройствами, такими как другие микроконтроллеры, компьютер, датчики, GPS или Bluetooth-модули, некоторые типы дисплеев и другие.

***[SPIx](#)***. SPI (последовательный периферийный интерфейс) - это протокол шины, который позволяет ESP32 взаимодействовать с периферийными устройствами или интегральными схемами, соответствующими протоколу SPI.

В рамках протокола одно устройство (обычно ESP32) действует как «ведущий» шины, а все остальные устройства — как «ведомые». Это означает, что одновременно происходит связь между ведущим и одним отдельным подчиненным. Подчиненные устройства не общаются друг с другом.

Назначение шины состоит в том, что можно подключить несколько устройств к ESP32 (ведущему устройству), используя минимум проводов.

***[I2Sx](#)***. I2S - это синхронный последовательный протокол связи, используемый для передачи цифровых аудиоданных между устройствами. Он предназначен для связи между микрофонами, аудиосенсорами, цифровыми и аналоговыми преобразователями и другими аудиоперифериями.

Протокол I2S использует три основные линии: 

- Serial Clock (SCK). Эта линия обеспечивает главный такт, который синхронизирует передачу битов между устройствами;
- Word Select (WS). Линия такта слова, она указывает, когда начинается новое слово данных (например, новый аудиоканал);
- Data Line (SD). Несёт сами цифровые аудиоданные. 

ESP32 содержит две I2S-периферии, которые можно настроить для ввода и вывода данных по протоколу I2S.

***[SDIO Slave](#)*** - «ведомое» устройство, подключённое к шине SDIO. Чип ESP32 оснащён встроенным интерфейсом SD-карт, который соответствует стандартному протоколу SDIO Card Specification Version 2.0. Он позволяет хост-контроллеру получать доступ к SoC с помощью интерфейса и протокола шины SDIO. 

Контроллер «ведомого» устройства (SDIO/SPI slave controller) поддерживает SDIO SPI, однобитный и четырёхбитный режимы обмена данными при тактовых частотах 0–50 МГц. Обмен данными между «ведущим» и «ведомым» устройствами реализуется по стандартному протоколу SDIO V2.0.

***[SDMMC](#)*** - это специальная аппаратная шина, которая используется на платах ESP32 и ESP32-S3 для работы с SD-картами. Она позволяет использовать 1, 4 или 8 контактов данных, а также 2 дополнительных контакта связи и 2 контакта питания.

Скорость работы SDMMC в 1-битном режиме примерно в два раза выше, чем в режиме SPI, а в 4-битном режиме примерно в три раза выше, чем в режиме SPI.

***[EMAC](#)*** - это интерфейс Ethernet MAC, который обеспечивает канальный уровень передачи данных (аббревиатура от англ. Media Access Control). Он отвечает за управление и подключение физической среды физического уровня.

###### [в начало](#%D0%B2%D1%81%D0%B5-%D0%BF%D1%80%D0%BE-%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D1%8C-esp32)

### Периферийные устройства

ESP32 оснащен 41 периферийным устройством. В следующих таблицах подробно описаны периферийные устройства и соответствующие
им диапазоны адресов. Доступ к почти всем периферийным модулям может осуществляться любым процессором по одному и тому же адресу, за единственным исключением - это PID-контроллер.

![](PeripheralAddressMapping1.jpg)

![](PeripheralAddressMapping2.jpg)

Замечание:

- Периферийные устройства, доступ к которым осуществляется центральным процессором через адресное пространство 0x3FF40000 - 0x3FF7FFFF (адрес DPORT), также могут быть доступны через 0x60000000 - 0x6003FFFF (адрес AHB). 



### Библиография

#### [Руководство по программированию ESP-IDF ESPRESSIF 5.3.1](https://docs.espressif.com/projects/esp-idf/en/v5.3.1/esp32/index.html)

#### [ESP32 Техническое справочное руководство версии 5.2](esp32_technical_reference_manual_en.pdf)

#### [ESP32: типы памяти](https://microsin.net/programming/arm/esp32-memory-types.html)

###### [в начало](#%D0%B2%D1%81%D0%B5-%D0%BF%D1%80%D0%BE-%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D1%8C-esp32)
