## Паровозик КРУТЯК

### [1. Система кoманд ИК-пульта управления паровозиком](#%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0-%D0%BA%D0%BE%D0%BC%D0%B0%D0%BD%D0%B4-%D0%B8%D0%BA-%D0%BF%D1%83%D0%BB%D1%8C%D1%82%D0%B0-%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BF%D0%B0%D1%80%D0%BE%D0%B2%D0%BE%D0%B7%D0%B8%D0%BA%D0%BE%D0%BC)

### [2. How to use an IR receiver and remоte with Arduino](#how-to-use-an-ir-receiver-and-remote-with-arduino)

### [3. Хронoлогия событий](#%D1%85%D1%80%D0%BE%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D1%8F-%D1%81%D0%BE%D0%B1%D1%8B%D1%82%D0%B8%D0%B9)

### [4. Прo ШИМ](#%D0%BF%D1%80%D0%BE-%D1%88%D0%B8%D0%BC)

### [5. Прo полевой транзистор IRFZ24N](#%D0%BF%D1%80%D0%BE-%D0%BF%D0%BE%D0%BB%D0%B5%D0%B2%D0%BE%D0%B9-%D1%82%D1%80%D0%B0%D0%BD%D0%B7%D0%B8%D1%81%D1%82%D0%BE%D1%80-irfz24n)

### [6. Прo полевой транзистор IRF9Z24N](#%D0%BF%D1%80%D0%BE-%D0%BF%D0%BE%D0%BB%D0%B5%D0%B2%D0%BE%D0%B9-%D1%82%D1%80%D0%B0%D0%BD%D0%B7%D0%B8%D1%81%D1%82%D0%BE%D1%80-irf9z24n)

### [7. Драйвер мoтора - управление скоростью и направлением от потенциометра](#%D0%B4%D1%80%D0%B0%D0%B9%D0%B2%D0%B5%D1%80-%D0%BC%D0%BE%D1%82%D0%BE%D1%80%D0%B0---%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D1%81%D0%BA%D0%BE%D1%80%D0%BE%D1%81%D1%82%D1%8C%D1%8E-%D0%B8-%D0%BD%D0%B0%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%D0%BC-%D0%BE%D1%82-%D0%BF%D0%BE%D1%82%D0%B5%D0%BD%D1%86%D0%B8%D0%BE%D0%BC%D0%B5%D1%82%D1%80%D0%B0)

### [8. Трассировка сигналoв от потенциометра и на двигатель](#%D1%82%D1%80%D0%B0%D1%81%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0-%D1%81%D0%B8%D0%B3%D0%BD%D0%B0%D0%BB%D0%BE%D0%B2-%D0%BE%D1%82-%D0%BF%D0%BE%D1%82%D0%B5%D0%BD%D1%86%D0%B8%D0%BE%D0%BC%D0%B5%D1%82%D1%80%D0%B0-%D0%B8-%D0%BD%D0%B0-%D0%B4%D0%B2%D0%B8%D0%B3%D0%B0%D1%82%D0%B5%D0%BB%D1%8C)

### Система команд ИК-пульта управления паровозиком
```
 1 - "стоп паровоз"       - TV-VCR   
 2 - "включить/выключить" - ON standby  
 3 -                      - A.REP 
20 - "начать движение"    - REC     
21 - "назад"              - == 
22 -                      - >|<     
24 - "медленнее"          - <<    
25 - "вперед"             - =>
26 - "быстрее"            - >>   
 
32 -                      - EJECT
33 -                      - A.TRK
44 - "подключить"         - TRACKING ON 
45 - "отключить"          - TRACKING OFF 
50 -                      - SYSTEM
```

### [How to use an IR receiver and remote with Arduino](https://www.makerguides.com/ir-receiver-remote-arduino-tutorial/)

ИК-пульт дистанционного управления и приемник взаимодействуют друг с другом путем передачи и декодирования сигнала в виде импульсного ИК-излучения.

![Отправленный и обнаруженный сигнал, ИК-передатчик слева - приемник справа](ir-signal-transmission.gif)

Инфракрасное излучение (ИК), или инфракрасный свет, представляет собой тип электромагнитного излучения с длиной волны от 700 нм до 1 мм. Поскольку люди могут видеть свет только с длиной волны примерно от 400 (фиолетовый) до 700 (красный) нанометров, ИК-излучение невидимо для человеческого глаза.

ИК-светодиод в вашем пульте дистанционного управления - не единственный источник ИК-излучения. Любой объект, имеющий температуру, также излучает в инфракрасном спектре. Это явление также используется тепловизионными камерами для обнаружения тепла.

Весь этот окружающий ИК-сигнал может мешать связи между пультом дистанционного управления и приемником. Но это устраняется модуляцией сигнала.

При модуляции сигнала источник ИК-излучения на конце пульта дистанционного управления мигает с определенной частотой. В бытовой электронике эта несущая частота обычно составляет около 38 кГц.

Эта конкретная частота используется для коммерческой ИК-передачи, поскольку она встречается редко в природе и, следовательно, ее можно отличить от окружающего ИК-излучения.

Приемник построен таким образом, что пропускает только ИК-излучение, поступающее с частотой 38 кГц. Это достигается с помощью полосового фильтра и усилителя. Затем демодулированный двоичный сигнал отправляется на микроконтроллер (Arduino), где он декодируется.

#### [Скетч проверки команд управления](proverka-komand-upravleniya/proverka-komand-upravleniya.ino) 

![](proverka-komand-upravleniya/ardu-ir_bb-1024x477.png)

### Хронология событий

#### [2024-03-10](#) Разборка паровоза и идея.

1. Скорость паровоза изменяется в "дискретах" от 0 до 255. "Пакет дискрет" - программно изменяемое количество дискрет, которое определяет как изменяется скорость (на какое количество дискрет) при нажатии на клавиши "быстрее" или "медленнее".

2. Встроенный динамик подает сигналы, когда начинает движение и меняет скорость.

#### [2024-03-11](#) 
Собрал простейшую схему управления скоростью вращения электромотора с помощью переменного резистора с использованием [ШИМ](#%D0%BF%D1%80%D0%BE-%D1%88%D0%B8%D0%BC) (англ. PWM, широтно-импульсной модуляцией). 

#### [Скетч простейшей схемы управления скоростью и направлением вращения электромотора](upravlenie-skorostyu-i-napravleniem-ot-potenciometra/upravlenie-skorostyu-i-napravleniem-ot-potenciometra.ino) 

В скетче используется полевой транзистор [IRFZ24N](#%D0%BF%D1%80%D0%BE-%D0%BF%D0%BE%D0%BB%D0%B5%D0%B2%D0%BE%D0%B9-%D1%82%D1%80%D0%B0%D0%BD%D0%B7%D0%B8%D1%81%D1%82%D0%BE%D1%80-irfz24n). Это позволяет не менять мощности двигателя при изменении скорости. Скетч отслеживает положение потенциометра и преобразовывает его в сигнал ШИМ, который с пина контроллера D10 попадает на затвор полевого транзистора VT1. Транзистор работает в режиме ключа и выполняет роль драйвера, позволяя управлять двигателем, не нагружая выход Arduino.

Таким образом скетч выполняет задачу установления сигнала ШИМ на выходе с коэффициентом заполнения, прямо пропорциональным уровню сигнала на аналоговом входе. 

#### [2024-03-12](#) Система контроля и протокола.
Мысль такая. В следующем вагоне после паровоза находится СКИП - система контроля и протокола: с ИК-датчиком тоже (или команда будет приходить от системы управления паровозом). Если будет второй датчик, то он должен будет ловить сигналы от пульта вместе с ИК-датчиком паровоза. Все действия отображаются на мониторе ().

#### [2024-03-25](#) Драйвер мотора - управление скоростью и направлением от потенциометра.
Схема драйвера состоит из двух одинаковых плеч (левого и правого). Каждое плечо состоит двух полевых транзисторов (сверху IRF9Z24N - p-канальный, снизу IRFZ24N - n-канальный). Транзисторы соединены затворами (вход управляющего напряжения) и стоками (выход - исполнительное напряжение для двигателя).

#### [2024-03-29](#) Администратор мотора - инструмент инфракрасного управления 

Инструмент инфракрасного управления - ***Infrared control tool***. 


### Про ШИМ

Некоторые из цифровых выходов Arduino способны чередовать "0" и "1" с частотой ***490 Гц*** с заданным коэффициентом заполнения (длительностью импульсов), позволяя получить на выходе определенное напряжение. Чем больше длительность импульсов, тем выше напряжение. Коэффициент заполнения ШИМ указывается от ***0 (0%)*** до ***255 (100%)***. Функция ***analogWrite(pin, value)*** (где pin - порт входа/выхода на который подаётся ШИМ сигнал; value - коэффициент заполнения, значение между 0 (полностью выключено) and 255 (сигнал подан постоянно)) выдает аналоговую величину (ШИМ волну) на порт входа/выхода. После вызова analogWrite() на выходе будет генерироваться постоянная прямоугольная волна с заданной шириной импульса до следующего вызова analogWrite (или вызова digitalWrite или digitalRead на том же порту входа/выхода).

![](arduino-shim.webp) 

### Про полевой транзистор IRFZ24N

IRFZ24N является мощным n-канальным МОП (MOSFET) транзистором. 

#### Замечание
> Ардуино, при выдаваемых на контакт ***5В*** выдерживает ток в ***40мА***. Мощные моторы или сверхъяркие светодиоды могут потреблять сотни миллиампер. При подключении таких нагрузок напрямую чип может быстро выйти из строя. Кроме того для работоспособности некоторых компонентов требуется напряжение большее, чем 5В.
> 
> Зато, его с лёгкостью хватит для управления транзистором, который в свою очередь будет управлять большим током (например для подключения длинной светодиодной ленты, которая требует 12В и при этом потребляет 100мА).

[Характеристики](https://shematok.ru/transistor/irfz24n)
```
Максимальное напряжение сток-исток (Uси):    55В;
Максимальный продолжительный ток стока (Iс): 17А;
Максимальный импульсный ток стока (Iс):      68А;
Ток утечки стока:                            25мкА (при Uси = 55В);
Ток утечки затвора:                          100нА (при Uзи = 20В);
Сопротивление открытого канала (Rси):        70мOм (0.07Ом);
Пороговое напряжение затвор-исток (UGS):     2... 4В;
Максимальное напряжение затвор-исток (Uзи):  ±20В;
Максимальная рассеиваемая мощность (Pси):    45Вт;
Крутизна характеристики:                     4,5S;
Время задержки включения:    4,9нс (при Uси = 28В, Iс = 10A);
Время задержки выключения:    19нс (при Uси = 28В, Iс = 10A);
Корпус:                                      ТО-220;

--- Максимальная температура канала (Tj) - этот параметр ограничивает 
    температуру канала транзистора во включенном состоянии. Если ее превысить,
    срок службы транзистора может сократиться.

--- Общий заряд затвора (Qg) — заряд, который нужно сообщить затвору 
    для открытия транзистора. Чем меньше этот параметр, тем меньшая мощность
    требуется для управления транзистором.

--- Время нарастания (tr) - время, за которое ток стока увеличится 
    с 10% до 90% от указанного.
    
--- Сопротивление сток-исток открытого транзистора (Rds) - сопротивление
открытого канала сток-исток при заданных параметрах: Id, Vgs и Tj.
```
### Про полевой транзистор IRF9Z24N

IRF9Z24N является мощным p-канальным МОП (MOSFET) транзистором. 

Полевые транзисторы обладают тремя контактами:

- Сток (drain) — на него подаётся высокое напряжение, которым хочется управлять
- Затвор (gate) — на него подаётся напряжение, чтобы разрешить течение тока; затвор заземляется, чтобы заблокировать ток.
- Исток (source) — через него проходит ток со стока, когда транзистор «открыт»


[Характеристики](https://shematok.ru/transistor/irfz24n)
```
Максимальное напряжение сток-исток (Uси):             55В;
Макс.продолжительный ток стока (Iс) Vзи=-10В, t=25°C: -12A;
Макс.продолжительный ток стока Vзи=-10В, t=100°C:     -8.5А;
Максимальный импульсный ток стока (Iс):               -48А;
Сопротивление открытого канала (Rси):                 175мOм (0.175Ом);
Мощность макс:                                        45Вт;
Пороговое напряжение включения макс:                  4В;
Максимальное напряжение затвор-исток (Uзи):           ±20В;
Заряд затвора                                         19нКл
Входная емкость                                       350пФ
Корпус:                                               TO-220 Isolated Tab;
```
#### Замечание
> При работе с MOSFET транзисторами нужно учесть, что они могут быть повреждены статическим электричеством на ваших руках или одежде. Перед монтажом на печатную плату необходимо соединить выводы транзистора между собой тонкой проволокой. Для пайки лучше используйте паяльную станцию, а не обычный электрический паяльник. Вместо отсоса для удаления припоя используйте медную ленту для удаления припоя. Это уменьшит вероятность пробоя затвора статическим электричеством. Или используйте антистатический браслет.
> 

---

### Драйвер мотора - управление скоростью и направлением от потенциометра

![](upravlenie-skorostyu-i-napravleniem-ot-potenciometra/n-cha-p.jpg) 

![](upravlenie-skorostyu-i-napravleniem-ot-potenciometra/MotorOtPotenciometra.jpg) 

**Схема драйвера:**

Схема драйвера состоит из двух одинаковых плеч (левого и правого). Каждое плечо состоит двух полевых транзисторов (сверху IRF9Z24N - p-канальный, снизу IRFZ24N - n-канальный). Транзисторы соединены затворами (вход управляющего напряжения)
и стоками (выход - исполнительное напряжение для двигателя). 

Если на вход левого плеча (D10) подать "0", то верхний транзистор VT1 откроется, а нижний VT3 закроется. ... 

### [Скетч трассировки сигналов от потенциометра и на двигатель](trassirovka-signalov-ot-potenciometra-i-na-dvigatel/trassirovka-signalov-ot-potenciometra-i-na-dvigatel.ino)

Таблица снятых показаний со входа ***A0:PinRes*** -> ***ValRes*** и на выходах ***D10:PinPWM_L*** -> ***ValPWM_L***, ***D9:PinPWM_R*** -> ***ValPWM_R***:
```
ValRes    ValPWM_L    ValPWM_R          ValRes    ValPWM_L    ValPWM_R
потенциометр вправо        ==>          <==         потенциометр влево  
----------------------------------------------------------------------
 514           0           0             514          0            0
 497           8           0             535          0           11
 340          86           0             702          0           94
  60         226           0             828          0          157
   6         253           0            1000          0          243
   0         255           0            1023          0          255
```

### Администратор мотора - инструмент инфракрасного управления 

Инструмент инфракрасного управления - Infrared control tool. 

### [Скетч моделтрассировки сигналов от потенциометра и на двигатель](trassirovka-signalov-ot-potenciometra-i-na-dvigatel/trassirovka-signalov-ot-potenciometra-i-na-dvigatel.ino)

instrument-infrakrasnogo-upravleniya/instrument-infrakrasnogo-upravleniya.ino


###### [в начало](#%D0%BF%D0%B0%D1%80%D0%BE%D0%B2%D0%BE%D0%B7%D0%B8%D0%BA-%D0%BA%D1%80%D1%83%D1%82%D1%8F%D0%BA)
